<!-- Resolve the plugin parameter values -->
{{- if not (.Scratch.Get "plugin-conversation.Parameters") -}}
{{- partial "plugin-conversation/load-parameters.html" . -}}
{{- end -}}

{{- $Style := (.Scratch.Get "plugin-conversation.Parameters").Style -}}
{{- $HiddenItems := (.Scratch.Get "plugin-conversation.Parameters").Filter.HiddenItems -}}

<!-- Construct the URL -->
{{- $url := "https://micro.blog/conversation.js" -}}
{{- $queries := slice "url" $.Permalink "format" "jsonfeed" -}}
{{- $url = printf "%s?%s" $url (querify $queries) -}}

<!-- Fetch the conversation items -->
{{- $json_feed := getJSON $url -}}

<!-- Ensure there are items to display -->
{{- if $json_feed.items -}}

<div id="{{ $Style.WrapperID }}">

  <!-- Iterate the items -->
  {{- range $item := $json_feed.items -}}
  
    {{- if not (in $HiddenItems $item.id) -}}
    
<div id="{{ $item.id }}" class="u-comment h-cite">
  <a class="u-author h-card" href="{{ $item.author.url }}">
    <img class="u-photo" src="{{ $item.author.avatar }}" />
    <span class="p-nickname">{{ $item.author.name }}</span>
  </a>
  <p class="e-content p-name">
  {{- replace (replace $item.content_html "<p>" "") "</p>" "<br />" | strings.TrimSuffix "<br />" | safeHTML -}}
  </p>
  <a class="u-url" href="{{ $item.url }}">
    <small>
      <time class="dt-published">
        {{- time.Format "3:04 PM â€¢ Jan 2, 2006" $item.date_published -}}
      </time>
    </small>
  </a>
</div>

    {{- end -}}
  
  {{- end -}}

</div>

{{- end }}